# 스토리 추천 로직

| 순위 | 제품 칼럼         | 하위 제품         |
|------|------------------|------------------|
| 1    | Phone            | Mobile           |
| 2    | Tab              |                  |
| 3    | Wearables        | Watch, Buds      |
| 4    | SmartTag         |                  |
| 5    | TV               |                  |
| 6    | Speaker          |                  |
| 7    | Refrigerator     |                  |
| 8    | Laundry          | Washer           |
| 9    | Dryer            |                  |
| 10   | Air Conditioner  |                  |
| 11   | Robot Cleaner    |                  |
| 12   | Dish Washer      |                  |
| 13   | Oven             |                  |
| 14   | Cooktop          |                  |
| 15   | Lighting         |                  |
| 16   | Outlet           |                  |
| 17   | Motion Sensor    |                  |
| 18   | Temp/Humidity    |                  |
| 19   | Open/Closed Sensor |                |
| 20   | Water Leak Sensor |                 |
| 21   | Camera           |                  |
| 22   | Doorbell         |                  |
| 23   | Smart Home Hub   |                  |
| 24   | Window Treatment |                  |
| 25   | Pet Feeder       |                  |

## 예외 상황 처리 규칙
A. 관심사키워드가 '-'인 경우:
   - 보유제품이 있으면: 전체 스토리에서 제품 매칭으로 진행
   - 보유제품도 '-'이면: "최종 스토리 도출: 38-2, 38-1" (기본값)
B. 보유제품이 '-'인 경우:
   - 관심사키워드가 있으면: 관심사키워드 일치 스토리만 사용
   - 관심사키워드도 '-'이면: 예외 A와 동일
C. 확정 스토리 (관심사키워드 일치 스토리가 1개):
   - 해당 스토리를 1순위로 고정
   - 확정 스토리를 제외한 전체 스토리 데이터로 2단계부터 적용하여 2순위 결정

---

## 데이터 설명
1. [계정 데이터]
   - 계정명: 계정 정보
   - 관심사키워드: story.csv의 관심사키워드와 비교하는 컬럼
   - 보유제품: story.csv의 Phone ~ Pet Feeder 컬럼과 비교하는 컬럼.
2. [스토리 데이터]
   - 관심사키워드: account.csv의 해당 계정의 관심사키워드 값과 비교하는 컬럼.
   - 스토리ID: 최종 결과에 표시되는 값.
   - Phone, Tab, ..., Pet Feeder: 각 스토리별로 구성된 제품군 컬럼. 해당 스토리가 해당하는 컬럼의 제품을 가지고 있다면 값이 있고, 없다면 비어있음. 여기서는 제품 컬럼이라 칭하며 제품 컬럼 내 위치가 우선순위를 가진다.

## 공통 규칙
- 모든 reasoning, 표 출력, 설명은 반드시 한글로 진행하라.
- 단계별로 차례대로 실행하라.
- 각 단계마다 상세한 reasoning을 진행하고 출력하라.
- 표는 반드시 마크다운 표 형식으로 출력하라.
- reasoning, 표, 설명 등 모든 출력은 반드시 한글로 진행하라.
- 누락된 스토리, 규칙 위반, 예외 상황 등은 reasoning에서 반드시 명확히 언급하라.

---

## 1단계: 계정별 관심사키워드 일치 스토리 도출
- [스토리 데이터] 표의 '관심사키워드' 컬럼 값만 보고, 계정의 관심사키워드와 정확히 일치하는 스토리만 한 행도 빠짐없이 모두 도출하라.
- 다른 컬럼(제품 등)은 절대 비교하지 마라.
- 누락된 스토리가 있으면 규칙 위반임을 명확히 표기하라.
- 관심사키워드와 정확히 일치하는 스토리의 개수를 출력하라.
- 1단계에서 관심사키워드 일치 스토리가 1개라면 이 1개의 일치 스토리를 확정 스토리라 한다.:
    1) 확정 스토리는 부동의 1순위가 되며, 확정 스토리를 제외한 전체 스토리로 2단계부터 진행한다.
    2) 8단계에서 확정 스토리를 1등, 7단계까지의 1순위를 2등으로 정한다.
- 확정 스토리가 없다면: 관심사키워드가 일치하는 스토리들의 표만 2단계의 대상이 된다.
- 만약 계정의 관심사키워드가 '-'로 되어있고, 보유제품이 '-'로 되어 있다면, reasoning 후 2단계로 넘어가지 않고 "최종 스토리 도출: 38-2, 38-1"로 출력한다.
- 만약 계정의 관심사키워드가 '-'로 되어 있다면, reasoning 후 전체 스토리 표를 2단계 이후의 대상으로 한다.
- **이 단계에서는 반드시 일치 스토리 전체를 표로 출력한다.**
- 이 단계 표 컬럼: No. | 관심사키워드 | 스토리ID | Phone | Tab | Wearables | SmartTag | TV | ... | Pet Feeder
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 2단계: 보유제품 일치/미일치 개수 계산
- 1단계 표를 기준으로 계정의 보유제품과 비교하여 일치/미일치 개수를 계산한다.
- '일치'란, 계정의 보유제품과 스토리의 제품 컬럼이 모두 일치하는 경우를 의미한다.
- '미일치'란, 부족 보유제품과 초과 보유제품을 모두 포함한다.
- 이 단계에서는 표를 출력하지 않는다. reasoning과 요약만 출력한다.
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 3단계: 일치개수가 많은 순서로 정렬
- 2단계에서 계산된 일치개수를 기준으로, 내림차순 정렬한다.
- 이 단계부터 등수제를 도입한다. (예: 1등이 3개면 다음 등수는 4등)
- **등수제**:
  - **1등이 3개 이상일 경우, 1등만 남기고 나머지는 소거한다.**
  - **1등+2등을 합쳐 3개 이상일 경우, 해당 등수(1,2등)만 남기고 나머지는 소거한다.**
  - **그 외에는 기존대로 동점자만 다음 단계로 진행한다.**
  - **남은 스토리가 2개가 되면 그 단계에서 멈춘다.**
  - 동점자(동일 값)는 같은 등수로 처리하며, 그 다음 등수는 동점자 수만큼 건너뛴다.
  - 동점자 처리 예시: 1,1,1,4,5,6
  - **예시:**
    - 1등이 4개, 2등이 2개인 경우 → 1등만 남기고 2등은 모두 소거
    - 1등이 2개, 2등이 2개(총 4개)인 경우 → 1,2등만 남기고 3등 이하 소거
    - 1등이 1개, 2등이 1개, 3등이 1개인 경우 → 기존대로 동점자만 다음 단계로 진행
  - 등수제를 통해 남은 행이 3개 이상일 경우 다음 단계를 적용한다.
- 이 단계 표 컬럼: **등수** | No. | 관심사키워드 | 스토리ID | 일치개수 | 미일치개수 | 구성제품
- 구성제품에는 해당 스토리의 제품 컬럼에 있던 값들을 의미한다.
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 4단계: 동일 관심사키워드 내 일치제품별 스토리 개수 계산
- 3단계에서 동점(일치개수 동일)인 스토리에 한해, 동일 관심사키워드 내에서 각 일치제품별로 해당 제품이 포함된 스토리의 개수를 계산하여 표에 추가한다.
- 이 단계에서는 표를 출력하지 않는다. reasoning과 요약만 출력한다.
- 예시:
  - 보유제품이 Mobile, Buds일 때
  - Mobile만 포함하고 있는 스토리(4개)가 존재
  - Buds만 포함하고 있는 스토리(1개)
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 5단계: 해당제품포함스토리수 기준 정렬
- 4단계에서 계산된 해당제품포함스토리수를 기준으로, 적은 순서로 정렬한다.
- 이 단계부터 등수제를 유지한다. (예: 1등이 2개면 다음 등수는 3등)
- 동점자(동일 값)는 같은 등수로 처리하며, 그 다음 등수는 동점자 수만큼 건너뛴다.
- 동점자 처리 예시: 1,1,3,4
- 동점일 경우에만 6단계로 진행한다.
- 이 단계 표 컬럼: **등수** | No. | 관심사키워드 | 스토리ID | 일치개수 | 미일치개수 | 해당제품포함스토리수
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 6단계: 일치제품의 제품 우선순위 계산
- 5단계에서 동점(해당제품포함스토리수 동일)인 스토리에 한해, 각 스토리의 일치제품들 중에서 가장 높은 우선순위(숫자가 작은)를 계산하여 표에 추가한다.
- 이 단계에서는 표를 출력하지 않는다. reasoning과 요약만 출력한다.
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 7단계: 일치제품순위 기준 정렬
- 6단계에서 계산된 일치제품순위를 기준으로, 숫자가 작은 순서(우선순위가 높은 순서)로 정렬한다.
- 이 단계부터 등수제를 유지한다. (예: 1등이 2개면 다음 등수는 3등)
- 동점자(동일 값)는 같은 등수로 처리하며, 그 다음 등수는 동점자 수만큼 건너뛴다.
- 동점자 처리 예시: 1,1,3,4
- 동점일 경우에만 8단계로 진행한다.
- 이 단계 표 컬럼: **등수** | No. | 관심사키워드 | 스토리ID | 일치개수 | 미일치개수 | 해당제품포함스토리수 | 일치제품 | 일치제품순위
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 8단계: 미일치개수 기준 정렬
- 7단계에서 동점(일치제품순위 동일)인 스토리에 한해, 미일치개수를 기준으로, 적은 순서로 정렬한다.
- 이 단계부터 등수제를 유지한다. (예: 1등이 2개면 다음 등수는 3등)
- 동점자(동일 값)는 같은 등수로 처리하며, 그 다음 등수는 동점자 수만큼 건너뛴다.
- 동점자 처리 예시: 1,1,3,4
- 동점일 경우에만 9단계로 진행한다.
- 이 단계 표 컬럼: **등수** | No. | 관심사키워드 | 스토리ID | 일치개수 | 미일치개수 | 해당제품포함스토리수 | 일치제품 | 일치제품순위 | 미일치제품 | 미일치제품순위
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 9단계: 미일치제품 및 미일치제품순위 계산
- 8단계에서 동점(미일치개수 동일)인 스토리에 한해, 각 스토리의 미일치제품과 그 중 가장 높은 우선순위(숫자가 작은)를 계산하여 표에 추가한다.
- 이 단계에서는 표를 출력하지 않는다. reasoning과 요약만 출력한다.
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 10단계: 미일치제품순위 기준 정렬
- 9단계에서 계산된 미일치제품순위를 기준으로, 숫자가 작은 순서(우선순위가 높은 순서)로 정렬한다.
- 이 단계부터 등수제를 유지한다. (예: 1등이 2개면 다음 등수는 3등)
- 동점자(동일 값)는 같은 등수로 처리하며, 그 다음 등수는 동점자 수만큼 건너뛴다.
- 동점자 처리 예시: 1,1,3,4
- 이 단계 표 컬럼: **등수** | No. | 관심사키워드 | 스토리ID | 일치개수 | 미일치개수 | 해당제품포함스토리수 | 일치제품 | 일치제품순위 | 미일치제품 | 미일치제품순위
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## 11단계: 최종 스토리 도출
- 10단계에서 도출된 스토리ID의 개수와 조합에 따라 아래와 같이 최종 스토리 도출 결과를 표기하라.
- 반드시 reasoning 후 아래 형식으로 한글로 출력하라.
- 규칙:
  1. 11단계에서 총 4개의 스토리가 도출되고 스토리ID가 35-1, 35-3, 42-3, 35-2인 경우,
     - 반드시 "최종 스토리 도출: 35-1, 35-3, 42-3, 35-2 중 랜덤"으로 표기한다.
  2. 11단계에서 총 2개의 스토리가 도출된다면,
     - "최종 스토리 도출: 1순위스토리ID, 2순위스토리ID"로 표기한다.
  3. 11단계에서 위 1, 2번 외의 경우가 생기면,
     - "최종 스토리 도출: 스토리ID들 [검토필요]"로 표기한다.
- 이 단계에서 반드시 결과에 대한 검증을 수행한다. 누락, 규칙 위반, 예외 상황, 데이터 이상 등은 reasoning에서 반드시 명확히 언급한다.

---

## [정렬 단계 공통 소거 규칙]
- 3단계뿐만 아니라, 이후 모든 정렬(등수제) 단계(예: 5, 7, 8, 10단계 등)에도 아래 규칙을 반복 적용한다.
- **1등이 3개 이상일 경우, 1등만 남기고 나머지는 소거한다.**
- **1등+2등을 합쳐 3개 이상일 경우, 해당 등수(1,2등)만 남기고 나머지는 소거한다.**
- **그 외에는 기존대로 동점자만 다음 단계로 진행한다.**
- **예외를 제외하고 남은 스토리가 2개가 되면 그 단계에서 멈춘다.**
- **예시:**
    - 1등이 4개, 2등이 2개인 경우 → 1등만 남기고 2등은 모두 소거
    - 1등이 2개, 2등이 2개(총 4개)인 경우 → 1,2등만 남기고 3등 이하 소거
    - 1등이 1개, 2등이 1개, 3등이 1개인 경우 → 기존대로 동점자만 다음 단계로 진행